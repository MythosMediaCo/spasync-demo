<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSpaSync Pro - Dashboard</title>
    <meta name="description" content="Professional medical spa reconciliation dashboard">
    
    <!-- Optimized Script Loading -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./api-service.js"></script>
    
    <!-- Optimized Styles -->
    <style>
        /* Core Variables */
        :root {
            --primary-blue: #3B82F6;
            --primary-green: #10B981;
            --primary-purple: #8B5CF6;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced Gradient Background */
        .gradient-bg {
            background: linear-gradient(135deg, var(--gray-50) 0%, #E0E7FF 50%, var(--gray-100) 100%);
            min-height: 100vh;
        }

        /* Optimized Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .card-interactive {
            cursor: pointer;
            border: 2px solid transparent;
        }

        .card-interactive:hover {
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Optimized Metric Cards */
        .metric-card {
            transition: all 0.2s ease;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Enhanced Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            cursor: pointer;
            text-decoration: none;
            border: none;
            line-height: 1.25;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563EB;
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-200);
        }

        .btn-success {
            background: var(--primary-green);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        /* Optimized Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #DCFCE7;
            color: #166534;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .badge-error {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* File Type Icons */
        .file-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .file-icon-pos { background: var(--primary-blue); color: white; }
        .file-icon-alle { background: var(--primary-green); color: white; }
        .file-icon-aspire { background: var(--primary-purple); color: white; }
        .file-icon-unknown { background: var(--gray-500); color: white; }

        /* Enhanced Loading States */
        .loading-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--gray-200);
            border-top: 2px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .loading-bounce {
            animation: bounce 1s infinite;
        }

        /* Animations */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .metric-card {
                padding: 1rem;
            }
            
            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
            .card { box-shadow: none !important; border: 1px solid var(--gray-300) !important; }
        }

        .print-only { display: none; }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus States */
        .btn:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
            padding: 1rem;
            max-width: 24rem;
            z-index: 50;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            border-left: 4px solid var(--primary-green);
        }

        .notification-error {
            border-left: 4px solid #EF4444;
        }

        .notification-info {
            border-left: 4px solid var(--primary-blue);
        }
    </style>
</head>
<body class="gradient-bg">
    <div id="dashboard-root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4" style="width: 3rem; height: 3rem; border-width: 3px;"></div>
                <p class="text-xl text-gray-600 font-medium">Loading MedSpaSync Pro...</p>
                <p class="text-sm text-gray-500 mt-2">Connecting to your enterprise dashboard</p>
            </div>
        </div>
    </div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        
        // Optimized Icon System - Simple SVG Components
        const Icon = ({ name, className = "w-5 h-5", ...props }) => {
            const icons = {
                // Core Icons
                upload: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12",
                fileText: "M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h8a2 2 0 002-2V8zM14 2v6h6M16 13H8M16 17H8M10 9H8",
                barChart: "M3 3v18h18M9 17V9m4 8V6m4 11V2",
                users: "M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2M9 7a4 4 0 108 0 4 4 0 00-8 0M22 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75",
                dollarSign: "M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6",
                clock: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 6v6l4 2",
                checkCircle: "M22 11.08V12a10 10 0 11-5.93-9.14M22 4L12 14.01l-3-3",
                alertTriangle: "M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01",
                xCircle: "M18 6L6 18M6 6l12 12",
                download: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3",
                refreshCw: "M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8M21 3v5h-5M21 12a9 9 0 01-9 9 9.75 9.75 0 01-6.74-2.74L3 16M3 21v-5h5",
                settings: "M12.22 2h-.44a2 2 0 00-2 2v.18a2 2 0 01-1 1.73l-.43.25a2 2 0 01-2 0l-.15-.08a2 2 0 00-2.73.73l-.22.38a2 2 0 000 2l.22.38a2 2 0 002.73.73l.15-.08a2 2 0 012 0l.43.25a2 2 0 011 1.73V20a2 2 0 002 2h.44a2 2 0 002-2v-.18a2 2 0 011-1.73l.43-.25a2 2 0 012 0l.15.08a2 2 0 002.73-.73l.22-.38a2 2 0 000-2l-.22-.38a2 2 0 00-2.73-.73l-.15.08a2 2 0 01-2 0l-.43-.25a2 2 0 01-1-1.73V4a2 2 0 00-2-2zM12 15a3 3 0 100-6 3 3 0 000 6z",
                logOut: "M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9",
                alertCircle: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 8v4M12 16h.01",
                trendingUp: "M22 7l-8.5 8.5L9 11l-7 7M16 7h6v6",
                calendar: "M3 9h18v10a2 2 0 01-2 2H5a2 2 0 01-2-2V9zM21 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v2M16 3v4M8 3v4",
                target: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 18a6 6 0 100-12 6 6 0 000 12zM12 14a2 2 0 100-4 2 2 0 000 4z",
                zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
                shield: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",
                activity: "M22 12h-4l-3 9L9 3l-3 9H2",
                database: "M4 6c0-1.326 3.582-3 8-3s8 1.674 8 3M4 6c0 1.326 3.582 3 8 3s8-1.674 8-3M4 6v6c0 1.326 3.582 3 8 3s8-1.674 8-3V6M4 12v6c0 1.326 3.582 3 8 3s8-1.674 8-3v-6",
                award: "M7.5 11.5a4.5 4.5 0 109 0 4.5 4.5 0 00-9 0zM8.5 21l3.5-7 3.5 7-3.5-1-3.5 1z",
                star: "M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z",
                home: "M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9zM9 22V12h6v10",
                folderOpen: "M6 14l1.45-2.9A2 2 0 019.24 10H20a2 2 0 011.94 2.5l-1.55 6a2 2 0 01-1.94 1.5H4a2 2 0 01-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 011.66.9L8 5h9a2 2 0 012 2v2",
                filePlus: "M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h8a2 2 0 002-2V8zM14 2v6h6M12 18v-6M9 15h6",
                arrowRight: "M5 12h14M12 5l7 7-7 7",
                chevronRight: "M9 18l6-6-6-6",
                play: "M8 5v14l11-7z",
                info: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 16v-4M12 8h.01",
                search: "M11 19a8 8 0 100-16 8 8 0 000 16zM21 21l-4.35-4.35",
                hash: "M4 9h16M4 15h16M10 3L8 21M16 3l-2 18",
                percent: "M19 5L5 19M6.5 6.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0zM12.5 12.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z",
                plus: "M12 5v14M5 12h14",
                x: "M18 6L6 18M6 6l12 12",
                check: "M20 6L9 17l-5-5",
                layers: "M12 2l8 4-8 4-8-4 8-4zM2 17l10 5 10-5M2 12l10 5 10-5",
                filter: "M22 3H2l8 9.46V19l4 2v-8.54L22 3z",
                briefcase: "M16 20V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v16M8 7h8a2 2 0 012 2v9a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2z",
                cpu: "M4 16v-2a2 2 0 00-2-2H0M4 8V6a2 2 0 012-2h2M20 8V6a2 2 0 00-2-2h-2M20 16v2a2 2 0 01-2 2h-2M22 12h-2a2 2 0 00-2 2v2M2 12h2a2 2 0 012-2V8M9 9h6v6H9V9z"
            };

            const path = icons[name];
            if (!path) {
                console.warn(`Icon "${name}" not found`);
                return <div className={`${className} bg-gray-300 rounded`}></div>;
            }

            return (
                <svg 
                    className={className} 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    {...props}
                >
                    <path d={path} />
                </svg>
            );
        };

        // Notification System
        const useNotification = () => {
            const [notifications, setNotifications] = useState([]);

            const showNotification = useCallback((message, type = 'info', duration = 4000) => {
                const id = Date.now();
                const notification = { id, message, type };
                
                setNotifications(prev => [...prev, notification]);
                
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== id));
                }, duration);
            }, []);

            return { notifications, showNotification };
        };

        // Main Dashboard Component
        const MedSpaSyncDashboard = () => {
            // State Management
            const [user, setUser] = useState(null);
            const [uploads, setUploads] = useState([]);
            const [reconciliationResults, setReconciliationResults] = useState(null);
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(false);
            const [initialLoading, setInitialLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dragActive, setDragActive] = useState(false);
            const [error, setError] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [selectedUploadIds, setSelectedUploadIds] = useState([]);
            const [reconciliationSettings, setReconciliationSettings] = useState({
                matchCriteria: 'normal',
                dateToleranceDays: 7,
                amountTolerancePercent: 5
            });
            const [generatingReport, setGeneratingReport] = useState(false);
            const [reportHistory, setReportHistory] = useState([]);

            const { notifications, showNotification } = useNotification();
            const fileInputRef = useRef(null);

            // API Service - Optimized
            const api = useMemo(() => {
                if (typeof window !== 'undefined' && window.MedSpaSyncAPI) {
                    try {
                        return new window.MedSpaSyncAPI();
                    } catch (e) {
                        console.error('Failed to initialize API:', e);
                        return null;
                    }
                }
                return null;
            }, []);

            // Utility Functions
            const formatCurrency = useCallback((amount) => {
                if (api?.formatCurrency) return api.formatCurrency(amount);
                return `$${parseFloat(amount || 0).toFixed(2)}`;
            }, [api]);

            const formatDate = useCallback((dateString) => {
                if (api?.formatDate) return api.formatDate(dateString);
                return new Date(dateString).toLocaleDateString();
            }, [api]);

            const getFileTypeConfig = useCallback((fileType) => {
                const configs = {
                    pos_transactions: { 
                        icon: 'database', 
                        label: 'POS Transactions', 
                        className: 'file-icon-pos',
                        badgeClass: 'badge-info'
                    },
                    alle_rewards: { 
                        icon: 'award', 
                        label: 'Alle Rewards', 
                        className: 'file-icon-alle',
                        badgeClass: 'badge-success'
                    },
                    aspire_certificates: { 
                        icon: 'star', 
                        label: 'Aspire Certificates', 
                        className: 'file-icon-aspire',
                        badgeClass: 'badge badge-warning'
                    },
                    unknown: { 
                        icon: 'fileText', 
                        label: 'Unknown Type', 
                        className: 'file-icon-unknown',
                        badgeClass: 'badge'
                    }
                };
                return configs[fileType] || configs.unknown;
            }, []);

            const getStatusConfig = useCallback((status) => {
                const configs = {
                    processed: { icon: 'checkCircle', className: 'text-green-600', label: 'Processed' },
                    processing: { icon: 'refreshCw', className: 'text-blue-600 loading-spinner', label: 'Processing' },
                    error: { icon: 'xCircle', className: 'text-red-600', label: 'Error' },
                    pending: { icon: 'clock', className: 'text-yellow-600', label: 'Pending' }
                };
                return configs[status] || configs.processed;
            }, []);

            // Data Loading Functions
            const loadUploadHistory = useCallback(async () => {
                if (!api) return;
                try {
                    const response = await api.getUploadHistory();
                    if (response.success) {
                        setUploads(response.uploads || []);
                        const recentUploads = (response.uploads || []).slice(0, 3);
                        setSelectedUploadIds(recentUploads.map(u => u.id));
                    } else {
                        throw new Error(response.error || 'Failed to load upload history');
                    }
                } catch (error) {
                    console.error('Failed to load upload history:', error);
                    setError(api.handleError(error, 'Loading upload history'));
                }
            }, [api]);

            const loadStats = useCallback(async () => {
                if (!api) return;
                try {
                    const response = await api.getStats();
                    if (response.success) {
                        setStats(response.stats);
                    }
                } catch (error) {
                    console.error('Failed to load stats:', error);
                }
            }, [api]);

            const loadReportHistory = useCallback(async () => {
                try {
                    const mockReports = [
                        {
                            id: 1,
                            type: 'Executive Summary',
                            createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                            matches: 47,
                            matchRate: 91.2,
                            timeSaved: 8.5
                        },
                        {
                            id: 2,
                            type: 'Detailed Analysis',
                            createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                            matches: 52,
                            matchRate: 89.7,
                            timeSaved: 9.2
                        }
                    ];
                    setReportHistory(mockReports);
                } catch (error) {
                    console.error('Failed to load report history:', error);
                }
            }, []);

            // File Upload Handler
            const handleFileUpload = useCallback(async (files) => {
                if (!api || !files.length) return;

                setLoading(true);
                setError(null);
                setUploadProgress(0);

                try {
                    const file = files[0];
                    const response = await api.uploadFile(file, (progress) => {
                        setUploadProgress(progress);
                    });

                    if (response.success) {
                        showNotification(`Successfully uploaded ${file.name}`, 'success');
                        await Promise.all([loadUploadHistory(), loadStats()]);
                        setUploadProgress(0);
                    } else {
                        throw new Error(response.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                    setError(api.handleError(error, 'File upload'));
                    setUploadProgress(0);
                } finally {
                    setLoading(false);
                }
            }, [api, showNotification, loadUploadHistory, loadStats]);

            // Reconciliation Handler
            const runReconciliation = useCallback(async () => {
                if (selectedUploadIds.length < 2) {
                    setError('Please select at least 2 files for reconciliation');
                    return;
                }

                if (!api) {
                    setError('API service not available');
                    return;
                }

                setLoading(true);
                setError(null);
                setReconciliationResults(null);

                try {
                    const response = await api.runReconciliation(selectedUploadIds, reconciliationSettings);

                    if (response.success) {
                        setReconciliationResults(response);
                        showNotification(`Reconciliation complete: ${response.summary.totalMatches} matches found with ${response.summary.matchRate}% success rate`, 'success');
                        setActiveTab('reconciliation');
                        await loadStats();
                    } else {
                        throw new Error(response.error || 'Reconciliation failed');
                    }
                } catch (error) {
                    console.error('Reconciliation failed:', error);
                    setError(api.handleError(error, 'Reconciliation'));
                } finally {
                    setLoading(false);
                }
            }, [selectedUploadIds, api, reconciliationSettings, showNotification, loadStats]);

            // Business Metrics Calculator
            const calculateBusinessMetrics = useCallback((summary) => {
                const totalRecords = summary.totalRecords || 0;
                const totalMatches = summary.totalMatches || 0;
                const matchRate = summary.matchRate || 0;

                const avgTimePerManualMatch = 15; // minutes
                const timeSavedHours = Math.round((totalMatches * avgTimePerManualMatch) / 60 * 100) / 100;
                const hourlyRate = 25; // USD per hour
                const costSavings = Math.round(timeSavedHours * hourlyRate);
                const avgRevenuePerMatch = 45; // Average revenue recovered per match
                const revenueRecovery = Math.round(totalMatches * avgRevenuePerMatch);
                const roi = costSavings > 0 ? Math.round(((revenueRecovery + costSavings) / 299) * 100) : 0;

                return {
                    timeSavedHours,
                    costSavings,
                    revenueRecovery,
                    roi,
                    efficiencyGain: Math.round((matchRate / 100) * 96),
                    processingSpeed: totalRecords > 0 ? Math.round(totalRecords / 0.5) + ' records/minute' : '0 records/minute'
                };
            }, []);

            // Drag and Drop Handlers
            const handleDrag = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileUpload(e.dataTransfer.files);
                }
            }, [handleFileUpload]);

            // Toggle Upload Selection
            const toggleUploadSelection = useCallback((uploadId) => {
                setSelectedUploadIds(prev => {
                    if (prev.includes(uploadId)) {
                        return prev.filter(id => id !== uploadId);
                    } else {
                        return [...prev, uploadId];
                    }
                });
            }, []);

            // File Input Handler
            const handleFileInputChange = useCallback((e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFileUpload(e.target.files);
                }
            }, [handleFileUpload]);

            // Logout Handler
            const handleLogout = useCallback(() => {
                if (api) {
                    api.logout();
                }
                showNotification('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/'; // ✅ FIXED: Redirect to new production login
                }, 1000);
            }, [api, showNotification]);

            // Report Generation
            const generateReport = useCallback(async (reportType) => {
                if (!reconciliationResults) {
                    setError('Please run a reconciliation first to generate reports');
                    return;
                }

                setGeneratingReport(true);

                try {
                    const summary = reconciliationResults.summary;
                    const businessMetrics = calculateBusinessMetrics(summary);

                    if (reportType === 'executive-summary') {
                        await generateExecutiveSummaryPDF(summary, businessMetrics);
                    } else if (reportType === 'detailed-analysis') {
                        await generateDetailedAnalysisExcel(reconciliationResults, businessMetrics);
                    }

                    const newReport = {
                        id: Date.now(),
                        type: reportType === 'executive-summary' ? 'Executive Summary' : 'Detailed Analysis',
                        createdAt: new Date().toISOString(),
                        matches: summary.totalMatches,
                        matchRate: summary.matchRate,
                        timeSaved: businessMetrics.timeSavedHours
                    };
                    setReportHistory(prev => [newReport, ...prev]);

                    showNotification(`${newReport.type} generated successfully`, 'success');

                } catch (error) {
                    console.error('Failed to generate report:', error);
                    setError('Failed to generate report. Please try again.');
                } finally {
                    setGeneratingReport(false);
                }
            }, [reconciliationResults, calculateBusinessMetrics, showNotification]);

            // Report Generation Functions
            const generateExecutiveSummaryPDF = async (summary, metrics) => {
                const reportContent = `
                    <div style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Arial, sans-serif;">
                        <div style="text-align: center; margin-bottom: 40px;">
                            <h1 style="color: #1E40AF; margin-bottom: 10px;">MedSpaSync Pro</h1>
                            <h2 style="color: #374151; margin-bottom: 5px;">Executive Reconciliation Summary</h2>
                            <p style="color: #6B7280; margin: 0;">Generated on ${new Date().toLocaleDateString()}</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 40px;">
                            <div style="background: #F3F4F6; padding: 20px; border-radius: 8px;">
                                <h3 style="color: #1F2937; margin-bottom: 15px;">Reconciliation Results</h3>
                                <p><strong>Total Matches:</strong> ${summary.totalMatches}</p>
                                <p><strong>Match Rate:</strong> ${summary.matchRate}%</p>
                                <p><strong>Total Records:</strong> ${summary.totalRecords}</p>
                                <p><strong>Exact Matches:</strong> ${summary.exactMatches}</p>
                                <p><strong>Fuzzy Matches:</strong> ${summary.fuzzyMatches}</p>
                            </div>
                            
                            <div style="background: #ECFDF5; padding: 20px; border-radius: 8px;">
                                <h3 style="color: #1F2937; margin-bottom: 15px;">Business Impact</h3>
                                <p><strong>Time Saved:</strong> ${metrics.timeSavedHours} hours</p>
                                <p><strong>Cost Savings:</strong> $${metrics.costSavings}</p>
                                <p><strong>Revenue Recovery:</strong> $${metrics.revenueRecovery}</p>
                                <p><strong>ROI:</strong> ${metrics.roi}%</p>
                                <p><strong>Efficiency Gain:</strong> ${metrics.efficiencyGain}%</p>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #E5E7EB;">
                            <p style="color: #6B7280; margin: 0;">MedSpaSync Pro - Enterprise Reconciliation Platform</p>
                            <p style="color: #6B7280; margin: 0;">© 2025 MythosMediaCo, LLC</p>
                        </div>
                    </div>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Executive Summary - MedSpaSync Pro</title>
                            <style>
                                body { margin: 0; padding: 0; }
                                @media print { body { margin: 0; } }
                            </style>
                        </head>
                        <body onload="window.print(); window.close();">
                            ${reportContent}
                        </body>
                    </html>
                `);
                printWindow.document.close();
            };

            const generateDetailedAnalysisExcel = async (results, metrics) => {
                let csv = 'MedSpaSync Pro - Detailed Reconciliation Analysis\n\n';
                
                csv += 'EXECUTIVE SUMMARY\n';
                csv += 'Metric,Value\n';
                csv += `Total Matches,${results.summary.totalMatches}\n`;
                csv += `Match Rate,${results.summary.matchRate}%\n`;
                csv += `Total Records,${results.summary.totalRecords}\n`;
                csv += `Time Saved,${metrics.timeSavedHours} hours\n`;
                csv += `Revenue Recovery,$${metrics.revenueRecovery}\n\n`;

                if (results.matches && results.matches.length > 0) {
                    csv += 'MATCHED RECORDS\n';
                    csv += 'Match Type,Confidence,File 1,Patient 1,Amount 1,File 2,Patient 2,Amount/Points 2\n';
                    
                    results.matches.forEach(match => {
                        csv += `${match.matchType},${Math.round(match.confidence * 100)}%,`;
                        csv += `${match.record1.fileName},${match.record1.data.patientName},${match.record1.data.amount || 'N/A'},`;
                        csv += `${match.record2.fileName},${match.record2.data.patientName},${match.record2.data.points || match.record2.data.amount || 'N/A'}\n`;
                    });
                }

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `MedSpaSync_Analysis_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Initialize App
            useEffect(() => {
                const initializeApp = async () => {
                    try {
                        if (!api) {
                            setError('API service not available. Please refresh the page.');
                            return;
                        }

                        // ✅ FIXED: Check authentication properly
                        if (!api.isAuthenticated()) {
                            console.log('Not authenticated, redirecting to login');
                            window.location.href = '/'; // ✅ FIXED: Redirect to new production login
                            return;
                        }

                        await api.healthCheck();

                        setUser({
                            firstName: "Test",
                            lastName: "User", 
                            email: "test@medspasync.com",
                            practice: {
                                name: "Demo Spa",
                                size: "small",
                                subscriptionTier: "trial"
                            }
                        });

                        await Promise.all([
                            loadUploadHistory(),
                            loadStats(),
                            loadReportHistory()
                        ]);

                    } catch (error) {
                        console.error('Failed to initialize app:', error);
                        setError(api ? api.handleError(error, 'Initialization') : 'Failed to initialize dashboard');
                        
                        if (error.message && error.message.includes('Authentication required')) {
                            setTimeout(() => {
                                window.location.href = '/'; // ✅ FIXED: Redirect to new production login
                            }, 2000);
                        }
                    } finally {
                        setInitialLoading(false);
                    }
                };

                initializeApp();
            }, [api, loadUploadHistory, loadStats, loadReportHistory]);

            // Initial Loading Screen
            if (initialLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center animate-slide-in">
                            <div className="relative mb-6">
                                <Icon name="shield" className="w-16 h-16 text-blue-600 mx-auto loading-pulse" />
                                <Icon name="zap" className="w-6 h-6 absolute top-0 right-0 text-yellow-500 loading-bounce" />
                            </div>
                            <p className="text-xl text-gray-600 font-medium flex items-center justify-center gap-2">
                                <Icon name="activity" className="w-5 h-5 loading-pulse" />
                                Connecting to MedSpaSync Pro...
                            </p>
                            <p className="text-sm text-gray-500 mt-2">Loading your enterprise dashboard</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    {/* Notifications */}
                    <div className="fixed top-4 right-4 z-50 space-y-2">
                        {notifications.map((notification) => (
                            <div
                                key={notification.id}
                                className={`notification notification-${notification.type} show animate-slide-in`}
                            >
                                <div className="flex items-center gap-3">
                                    <Icon 
                                        name={notification.type === 'success' ? 'checkCircle' : notification.type === 'error' ? 'xCircle' : 'info'} 
                                        className={`w-5 h-5 ${
                                            notification.type === 'success' ? 'text-green-600' : 
                                            notification.type === 'error' ? 'text-red-600' : 'text-blue-600'
                                        }`} 
                                    />
                                    <span className="text-sm font-medium text-gray-900">{notification.message}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Header */}
                    <header className="bg-white shadow-sm border-b no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-4">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                            <Icon name="barChart" className="w-5 h-5 text-white" />
                                        </div>
                                        <span className="text-xl font-bold text-gray-900">MedSpaSync Pro</span>
                                    </div>
                                    <div className="hidden md:flex items-center space-x-4">
                                        <span className="text-sm text-gray-400">|</span>
                                        <div className="flex items-center space-x-1">
                                            <Icon name="shield" className="w-4 h-4 text-green-600" />
                                            <span className="text-sm text-green-600 font-medium">Production</span>
                                        </div>
                                        <div className="flex items-center space-x-1">
                                            <Icon name="activity" className="w-4 h-4 text-blue-600 loading-pulse" />
                                            <span className="text-sm text-blue-600 font-medium">Live</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex items-center space-x-4">
                                    {user && (
                                        <div className="text-right">
                                            <div className="text-sm font-medium text-gray-900 flex items-center gap-1">
                                                <Icon name="users" className="w-4 h-4" />
                                                {user.firstName} {user.lastName}
                                            </div>
                                            <div className="text-xs text-gray-500 flex items-center gap-1">
                                                <Icon name="briefcase" className="w-3 h-3" />
                                                {user.practice.name}
                                            </div>
                                        </div>
                                    )}
                                    <button className="btn-secondary !p-2">
                                        <Icon name="settings" className="w-5 h-5" />
                                        <span className="sr-only">Settings</span>
                                    </button>
                                    <button onClick={handleLogout} className="btn-secondary !p-2">
                                        <Icon name="logOut" className="w-5 h-5" />
                                        <span className="sr-only">Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Error Alert */}
                        {error && (
                            <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 no-print animate-slide-in">
                                <div className="flex">
                                    <Icon name="alertCircle" className="h-5 w-5 text-red-400" />
                                    <div className="ml-3">
                                        <h3 className="text-sm font-medium text-red-800">Error</h3>
                                        <p className="mt-1 text-sm text-red-700">{error}</p>
                                        <button
                                            onClick={() => setError(null)}
                                            className="mt-2 text-sm text-red-600 hover:text-red-500 underline"
                                        >
                                            Dismiss
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Navigation Tabs */}
                        <div className="border-b border-gray-200 mb-8 no-print">
                            <nav className="-mb-px flex space-x-8">
                                {[
                                    { id: 'dashboard', name: 'Dashboard', icon: 'home' },
                                    { id: 'uploads', name: 'File Uploads', icon: 'upload' },
                                    { id: 'reconciliation', name: 'Reconciliation', icon: 'target' },
                                    { id: 'reports', name: 'Reports', icon: 'barChart' }
                                ].map((tab) => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex items-center space-x-2 py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <Icon name={tab.icon} className="w-5 h-5" />
                                        <span>{tab.name}</span>
                                        {activeTab === tab.id && <Icon name="chevronRight" className="w-4 h-4" />}
                                    </button>
                                ))}
                            </nav>
                        </div>

                        {/* Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-slide-in">
                                {/* Key Metrics */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div className="metric-card">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-blue-100 rounded-lg">
                                                <Icon name="database" className="h-6 w-6 text-blue-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Total Records</p>
                                                <p className="text-2xl font-semibold text-gray-900">{stats?.totalRecords || 0}</p>
                                                <p className="text-xs text-green-600 flex items-center gap-1">
                                                    <Icon name="trendingUp" className="w-3 h-3" />
                                                    Processed
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="metric-card">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-green-100 rounded-lg">
                                                <Icon name="folderOpen" className="h-6 w-6 text-green-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Total Uploads</p>
                                                <p className="text-2xl font-semibold text-gray-900">{stats?.totalUploads || 0}</p>
                                                <p className="text-xs text-blue-600 flex items-center gap-1">
                                                    <Icon name="clock" className="w-3 h-3" />
                                                    Files ready
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="metric-card">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-yellow-100 rounded-lg">
                                                <Icon name="target" className="h-6 w-6 text-yellow-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Ready to Reconcile</p>
                                                <p className="text-2xl font-semibold text-gray-900">{selectedUploadIds.length}</p>
                                                <p className="text-xs text-purple-600 flex items-center gap-1">
                                                    <Icon name="zap" className="w-3 h-3" />
                                                    Selected
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="metric-card">
                                        <div className="flex items-center">
                                            <div className="p-2 bg-purple-100 rounded-lg">
                                                <Icon name="activity" className="h-6 w-6 text-purple-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Potential Pairs</p>
                                                <p className="text-2xl font-semibold text-gray-900">{stats?.reconciliationOpportunities?.potentialPairs || 0}</p>
                                                <p className="text-xs text-indigo-600 flex items-center gap-1">
                                                    <Icon name="trendingUp" className="w-3 h-3" />
                                                    Opportunities
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Quick Actions */}
                                <div className="card p-6">
                                    <h3 className="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                                        <Icon name="zap" className="w-5 h-5 text-yellow-500" />
                                        Quick Actions
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <button
                                            onClick={() => setActiveTab('uploads')}
                                            className="btn btn-secondary justify-between"
                                        >
                                            <div className="flex items-center gap-2">
                                                <Icon name="filePlus" className="w-5 h-5 text-blue-600" />
                                                Upload New Files
                                            </div>
                                            <Icon name="arrowRight" className="w-4 h-4" />
                                        </button>
                                        <button
                                            onClick={runReconciliation}
                                            disabled={selectedUploadIds.length < 2 || loading}
                                            className="btn btn-primary"
                                        >
                                            {loading ? (
                                                <div className="loading-spinner"></div>
                                            ) : (
                                                <Icon name="play" className="w-5 h-5" />
                                            )}
                                            Run Reconciliation
                                        </button>
                                    </div>
                                </div>

                                {/* Recent Uploads */}
                                <div className="card">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <h3 className="text-lg font-medium text-gray-900 flex items-center gap-2">
                                            <Icon name="folderOpen" className="w-5 h-5 text-blue-600" />
                                            Recent Uploads
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        {uploads.length === 0 ? (
                                            <div className="text-center py-8">
                                                <Icon name="upload" className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                                                <p className="text-sm text-gray-500 mb-4">No files uploaded yet</p>
                                                <button
                                                    onClick={() => setActiveTab('uploads')}
                                                    className="btn btn-primary"
                                                >
                                                    <Icon name="filePlus" className="w-4 h-4" />
                                                    Upload your first file
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {uploads.slice(0, 5).map((upload) => {
                                                    const fileConfig = getFileTypeConfig(upload.fileType);
                                                    const statusConfig = getStatusConfig(upload.status);
                                                    
                                                    return (
                                                        <div key={upload.id} className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                                                            <div className="flex items-center space-x-3">
                                                                <div className={`file-icon ${fileConfig.className}`}>
                                                                    <Icon name={fileConfig.icon} className="w-4 h-4" />
                                                                </div>
                                                                <div>
                                                                    <p className="text-sm font-medium text-gray-900">{upload.fileName}</p>
                                                                    <p className="text-xs text-gray-500 flex items-center gap-1">
                                                                        <Icon name="hash" className="w-3 h-3" />
                                                                        {upload.recordCount} records
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center space-x-3">
                                                                <span className={`badge ${fileConfig.badgeClass}`}>
                                                                    <Icon name={statusConfig.icon} className={`w-3 h-3 ${statusConfig.className}`} />
                                                                    {fileConfig.label}
                                                                </span>
                                                                <span className="text-xs text-gray-500 flex items-center gap-1">
                                                                    <Icon name="calendar" className="w-3 h-3" />
                                                                    {formatDate(upload.createdAt)}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* File Uploads Tab */}
                        {activeTab === 'uploads' && (
                            <div className="space-y-8 animate-slide-in">
                                {/* Upload Zone */}
                                <div className="card p-6">
                                    <h3 className="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                                        <Icon name="upload" className="w-5 h-5 text-blue-600" />
                                        Upload Files
                                        <span className="badge badge-info">
                                            <Icon name="shield" className="w-3 h-3" />
                                            Secure
                                        </span>
                                    </h3>
                                    
                                    {/* Upload Progress */}
                                    {uploadProgress > 0 && uploadProgress < 100 && (
                                        <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm text-blue-700 flex items-center gap-1">
                                                    <div className="loading-spinner"></div>
                                                    Uploading...
                                                </span>
                                                <span className="text-sm text-blue-700 font-semibold">{uploadProgress}%</span>
                                            </div>
                                            <div className="w-full bg-blue-200 rounded-full h-3">
                                                <div
                                                    className="bg-blue-600 h-3 rounded-full transition-all duration-300"
                                                    style={{ width: `${uploadProgress}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    )}

                                    <div
                                        className={`border-2 border-dashed rounded-lg p-8 text-center transition-all duration-300 ${
                                            dragActive ? 'border-blue-500 bg-blue-50 transform scale-105' : 'border-gray-300'
                                        }`}
                                        onDragEnter={handleDrag}
                                        onDragLeave={handleDrag}
                                        onDragOver={handleDrag}
                                        onDrop={handleDrop}
                                    >
                                        <Icon name="upload" className={`h-12 w-12 mx-auto mb-4 ${dragActive ? 'text-blue-500 loading-bounce' : 'text-gray-400'}`} />
                                        <h4 className="text-lg font-medium text-gray-900 mb-2">
                                            Drop files here or click to upload
                                        </h4>
                                        <p className="text-sm text-gray-500 mb-4">
                                            Supports CSV and Excel files (POS transactions, Alle rewards, Aspire certificates)
                                        </p>
                                        <div className="flex items-center justify-center gap-4 text-xs text-gray-400 mb-4">
                                            <div className="flex items-center gap-1">
                                                <Icon name="database" className="w-3 h-3" />
                                                POS Data
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <Icon name="award" className="w-3 h-3" />
                                                Alle Rewards
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <Icon name="star" className="w-3 h-3" />
                                                Aspire Certs
                                            </div>
                                        </div>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept=".csv,.xlsx,.xls"
                                            onChange={handleFileInputChange}
                                            disabled={loading}
                                            className="hidden"
                                        />
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            disabled={loading}
                                            className="btn btn-primary"
                                        >
                                            <Icon name="filePlus" className="w-4 h-4" />
                                            Choose File
                                        </button>
                                    </div>
                                </div>

                                {/* Upload History */}
                                <div className="card">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-medium text-gray-900 flex items-center gap-2">
                                                <Icon name="layers" className="w-5 h-5 text-blue-600" />
                                                Upload History
                                            </h3>
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm text-gray-500 flex items-center gap-1">
                                                    <Icon name="checkCircle" className="w-4 h-4 text-green-600" />
                                                    {selectedUploadIds.length} selected for reconciliation
                                                </span>
                                                {selectedUploadIds.length >= 2 && (
                                                    <span className="badge badge-success">
                                                        <Icon name="zap" className="w-3 h-3" />
                                                        Ready
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Select
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        File Name
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Type
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Records
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Status
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Uploaded
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {uploads.map((upload) => {
                                                    const fileConfig = getFileTypeConfig(upload.fileType);
                                                    const statusConfig = getStatusConfig(upload.status);
                                                    const isSelected = selectedUploadIds.includes(upload.id);
                                                    
                                                    return (
                                                        <tr key={upload.id} className={`hover:bg-gray-50 transition-colors ${isSelected ? 'bg-blue-50' : ''}`}>
                                                            <td className="px-6 py-4 whitespace-nowrap">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isSelected}
                                                                    onChange={() => toggleUploadSelection(upload.id)}
                                                                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                                                />
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                                <div className="flex items-center gap-2">
                                                                    <div className={`file-icon ${fileConfig.className}`}>
                                                                        <Icon name={fileConfig.icon} className="w-3 h-3" />
                                                                    </div>
                                                                    {upload.fileName}
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap">
                                                                <span className={`badge ${fileConfig.badgeClass}`}>
                                                                    {fileConfig.label}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                {upload.recordCount}
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap">
                                                                <span className="badge badge-success">
                                                                    <Icon name={statusConfig.icon} className={`w-3 h-3 ${statusConfig.className}`} />
                                                                    {statusConfig.label}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                {formatDate(upload.createdAt)}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Reconciliation Tab */}
                        {activeTab === 'reconciliation' && (
                            <div className="space-y-8 animate-slide-in">
                                {/* Reconciliation Controls */}
                                <div className="card p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h3 className="text-lg font-medium text-gray-900 flex items-center gap-2">
                                            <Icon name="target" className="w-5 h-5 text-blue-600" />
                                            Reconciliation Analysis
                                            <span className="badge badge-info">
                                                <Icon name="cpu" className="w-3 h-3" />
                                                AI-Powered
                                            </span>
                                        </h3>
                                        <button
                                            onClick={runReconciliation}
                                            disabled={loading || selectedUploadIds.length < 2}
                                            className="btn btn-primary"
                                        >
                                            {loading ? (
                                                <div className="loading-spinner"></div>
                                            ) : (
                                                <Icon name="play" className="w-4 h-4" />
                                            )}
                                            {loading ? 'Analyzing...' : 'Start Reconciliation'}
                                        </button>
                                    </div>

                                    {/* Reconciliation Settings */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Match Criteria</label>
                                            <select
                                                value={reconciliationSettings.matchCriteria}
                                                onChange={(e) => setReconciliationSettings({...reconciliationSettings, matchCriteria: e.target.value})}
                                                className="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="strict">🎯 Strict (90%+ confidence)</option>
                                                <option value="normal">⚡ Normal (70%+ confidence)</option>
                                                <option value="fuzzy">🔍 Fuzzy (50%+ confidence)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Date Tolerance (days)</label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="30"
                                                value={reconciliationSettings.dateToleranceDays}
                                                onChange={(e) => setReconciliationSettings({...reconciliationSettings, dateToleranceDays: parseInt(e.target.value)})}
                                                className="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Amount Tolerance (%)</label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="50"
                                                value={reconciliationSettings.amountTolerancePercent}
                                                onChange={(e) => setReconciliationSettings({...reconciliationSettings, amountTolerancePercent: parseInt(e.target.value)})}
                                                className="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                    </div>

                                    <div className="text-sm text-gray-600 p-3 bg-blue-50 rounded-lg flex items-center gap-2">
                                        <Icon name="info" className="w-4 h-4 text-blue-600" />
                                        Selected {selectedUploadIds.length} files for reconciliation. 
                                        {selectedUploadIds.length < 2 ? (
                                            <span className="text-yellow-600 ml-1 flex items-center gap-1">
                                                <Icon name="alertTriangle" className="w-4 h-4" />
                                                (Select at least 2 files from the Uploads tab)
                                            </span>
                                        ) : (
                                            <span className="text-green-600 ml-1 flex items-center gap-1">
                                                <Icon name="checkCircle" className="w-4 h-4" />
                                                Ready to analyze!
                                            </span>
                                        )}
                                    </div>

                                    {loading && (
                                        <div className="text-center py-8 bg-blue-50 rounded-lg mt-4">
                                            <div className="flex justify-center mb-4">
                                                <div className="relative">
                                                    <Icon name="cpu" className="w-8 h-8 text-blue-600 loading-pulse" />
                                                    <Icon name="activity" className="w-4 h-4 absolute -top-1 -right-1 text-green-500 loading-bounce" />
                                                </div>
                                            </div>
                                            <p className="text-sm text-blue-700 font-medium flex items-center justify-center gap-1">
                                                <Icon name="zap" className="w-4 h-4 loading-pulse" />
                                                Running advanced reconciliation algorithms...
                                            </p>
                                            <p className="text-xs text-blue-600 mt-1">AI matching in progress</p>
                                        </div>
                                    )}
                                </div>

                                {/* Reconciliation Results */}
                                {reconciliationResults && (
                                    <div className="space-y-6">
                                        {/* Summary Cards */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div className="metric-card">
                                                <div className="flex items-center">
                                                    <div className="p-2 bg-green-100 rounded-lg">
                                                        <Icon name="checkCircle" className="h-6 w-6 text-green-600" />
                                                    </div>
                                                    <div className="ml-4">
                                                        <p className="text-sm font-medium text-gray-500">Total Matches</p>
                                                        <p className="text-2xl font-semibold text-gray-900">
                                                            {reconciliationResults.summary.totalMatches}
                                                        </p>
                                                        <p className="text-xs text-gray-500 flex items-center gap-1">
                                                            <Icon name="award" className="w-3 h-3 text-green-600" />
                                                            {reconciliationResults.summary.exactMatches} exact, {reconciliationResults.summary.fuzzyMatches} fuzzy
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="metric-card">
                                                <div className="flex items-center">
                                                    <div className="p-2 bg-blue-100 rounded-lg">
                                                        <Icon name="trendingUp" className="h-6 w-6 text-blue-600" />
                                                    </div>
                                                    <div className="ml-4">
                                                        <p className="text-sm font-medium text-gray-500">Match Rate</p>
                                                        <p className="text-2xl font-semibold text-gray-900">
                                                            {reconciliationResults.summary.matchRate}%
                                                        </p>
                                                        <p className="text-xs text-gray-500 flex items-center gap-1">
                                                            <Icon name="database" className="w-3 h-3 text-blue-600" />
                                                            {reconciliationResults.summary.totalRecords} total records
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="metric-card">
                                                <div className="flex items-center">
                                                    <div className="p-2 bg-purple-100 rounded-lg">
                                                        <Icon name="clock" className="h-6 w-6 text-purple-600" />
                                                    </div>
                                                    <div className="ml-4">
                                                        <p className="text-sm font-medium text-gray-500">Time Saved</p>
                                                        <p className="text-2xl font-semibold text-gray-900">
                                                            {reconciliationResults.summary.timeSaved?.timeSavedHours || calculateBusinessMetrics(reconciliationResults.summary).timeSavedHours}h
                                                        </p>
                                                        <p className="text-xs text-gray-500 flex items-center gap-1">
                                                            <Icon name="trendingUp" className="w-3 h-3 text-purple-600" />
                                                            vs manual reconciliation
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Success Alert */}
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <div className="flex">
                                                <Icon name="checkCircle" className="h-5 w-5 text-green-400" />
                                                <div className="ml-3">
                                                    <h3 className="text-sm font-medium text-green-800 flex items-center gap-1">
                                                        <Icon name="shield" className="w-4 h-4" />
                                                        Production Reconciliation Complete
                                                    </h3>
                                                    <p className="mt-1 text-sm text-green-700">
                                                        Real reconciliation completed successfully using your advanced algorithms. 
                                                        Results show actual matches from your uploaded files.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Matched Records */}
                                        {reconciliationResults.matches && reconciliationResults.matches.length > 0 && (
                                            <div className="card">
                                                <div className="px-6 py-4 border-b border-gray-200">
                                                    <h3 className="text-lg font-medium text-gray-900 flex items-center gap-2">
                                                        <Icon name="checkCircle" className="w-5 h-5 text-green-600" />
                                                        Matched Records
                                                        <span className="badge badge-success">
                                                            {reconciliationResults.matches.length} found
                                                        </span>
                                                    </h3>
                                                </div>
                                                <div className="p-6">
                                                    <div className="space-y-4">
                                                        {reconciliationResults.matches.map((match) => (
                                                            <div key={match.id} className="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                                                <div className="flex items-center justify-between mb-3">
                                                                    <span className={`badge ${
                                                                        match.matchType === 'exact' ? 'badge-success' : 'badge-warning'
                                                                    }`}>
                                                                        <Icon name={match.matchType === 'exact' ? 'checkCircle' : 'search'} className="w-3 h-3" />
                                                                        {match.matchType} match ({Math.round(match.confidence * 100)}% confidence)
                                                                    </span>
                                                                </div>
                                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                    <div className="p-3 bg-blue-50 rounded-lg">
                                                                        <p className="text-sm font-medium text-gray-900 flex items-center gap-1">
                                                                            <Icon name="fileText" className="w-4 h-4 text-blue-600" />
                                                                            {match.record1.fileName}
                                                                        </p>
                                                                        <p className="text-sm text-gray-600 mt-1">
                                                                            {match.record1.data.patientName} - {formatCurrency(parseFloat(match.record1.data.amount || 0))} - {match.record1.data.service}
                                                                        </p>
                                                                    </div>
                                                                    <div className="p-3 bg-green-50 rounded-lg">
                                                                        <p className="text-sm font-medium text-gray-900 flex items-center gap-1">
                                                                            <Icon name="fileText" className="w-4 h-4 text-green-600" />
                                                                            {match.record2.fileName}
                                                                        </p>
                                                                        <p className="text-sm text-gray-600 mt-1">
                                                                            {match.record2.data.patientName} - {match.record2.data.points} points - {match.record2.data.rewardType}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Reports Tab */}
                        {activeTab === 'reports' && (
                            <div className="space-y-8 animate-slide-in">
                                {/* Report Generation */}
                                <div className="card p-6">
                                    <h3 className="text-lg font-medium text-gray-900 mb-6 flex items-center gap-2">
                                        <Icon name="barChart" className="w-5 h-5 text-blue-600" />
                                        Export Reports
                                        <span className="badge badge-info">
                                            <Icon name="award" className="w-3 h-3" />
                                            Enterprise
                                        </span>
                                    </h3>
                                    
                                    {reconciliationResults ? (
                                        <div>
                                            {/* Business Intelligence Overview */}
                                            <div className="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                                                <h4 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                                    <Icon name="trendingUp" className="w-5 h-5 text-blue-600" />
                                                    Business Intelligence Summary
                                                </h4>
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div className="text-center bg-white p-4 rounded-lg shadow-sm">
                                                        <div className="flex items-center justify-center mb-2">
                                                            <div className="p-2 bg-blue-100 rounded-full">
                                                                <Icon name="target" className="w-6 h-6 text-blue-600" />
                                                            </div>
                                                        </div>
                                                        <p className="text-3xl font-bold text-blue-600">{reconciliationResults.summary.totalMatches}</p>
                                                        <p className="text-sm text-gray-600">Matches Found</p>
                                                    </div>
                                                    <div className="text-center bg-white p-4 rounded-lg shadow-sm">
                                                        <div className="flex items-center justify-center mb-2">
                                                            <div className="p-2 bg-green-100 rounded-full">
                                                                <Icon name="percent" className="w-6 h-6 text-green-600" />
                                                            </div>
                                                        </div>
                                                        <p className="text-3xl font-bold text-green-600">{reconciliationResults.summary.matchRate}%</p>
                                                        <p className="text-sm text-gray-600">Success Rate</p>
                                                    </div>
                                                    <div className="text-center bg-white p-4 rounded-lg shadow-sm">
                                                        <div className="flex items-center justify-center mb-2">
                                                            <div className="p-2 bg-purple-100 rounded-full">
                                                                <Icon name="clock" className="w-6 h-6 text-purple-600" />
                                                            </div>
                                                        </div>
                                                        <p className="text-3xl font-bold text-purple-600">{calculateBusinessMetrics(reconciliationResults.summary).timeSavedHours}h</p>
                                                        <p className="text-sm text-gray-600">Time Saved</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Report Generation Cards */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="card card-interactive p-6" onClick={() => generateReport('executive-summary')}>
                                                    <div className="flex items-center mb-4">
                                                        <div className="p-3 bg-blue-100 rounded-lg mr-4">
                                                            <Icon name="fileText" className="w-8 h-8 text-blue-600" />
                                                        </div>
                                                        <div>
                                                            <h4 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                                                Executive Summary
                                                                <Icon name="star" className="w-4 h-4 text-yellow-500" />
                                                            </h4>
                                                            <p className="text-sm text-gray-500">Professional PDF report for management</p>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-3 mb-4">
                                                        <p className="text-sm text-gray-600 flex items-center gap-2">
                                                            <Icon name="barChart" className="w-4 h-4 text-blue-500" />
                                                            High-level overview with {reconciliationResults.summary.totalMatches} matches 
                                                            and {reconciliationResults.summary.matchRate}% success rate
                                                        </p>
                                                        <p className="text-sm text-gray-600 flex items-center gap-2">
                                                            <Icon name="dollarSign" className="w-4 h-4 text-green-500" />
                                                            ROI analysis showing ${calculateBusinessMetrics(reconciliationResults.summary).revenueRecovery} potential recovery
                                                        </p>
                                                        <p className="text-sm text-gray-600 flex items-center gap-2">
                                                            <Icon name="clock" className="w-4 h-4 text-purple-500" />
                                                            Time savings: {calculateBusinessMetrics(reconciliationResults.summary).timeSavedHours} hours vs manual processing
                                                        </p>
                                                    </div>
                                                    <button 
                                                        disabled={generatingReport}
                                                        className="btn btn-primary w-full"
                                                    >
                                                        {generatingReport ? (
                                                            <div className="loading-spinner"></div>
                                                        ) : (
                                                            <Icon name="download" className="w-4 h-4" />
