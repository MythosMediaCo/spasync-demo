<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSpaSync Pro - Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./api-service.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body class="gradient-bg">
    <div id="dashboard-root">
        <div class="flex items-center justify-center min-h-screen bg-gray-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto"></div>
                <p class="mt-6 text-xl text-gray-600">Loading MedSpaSync Pro Dashboard...</p>
                <p class="mt-2 text-sm text-gray-500">Connecting to your reconciliation system</p>
            </div>
        </div>
    </div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const {
            Upload, FileText, BarChart3, Users, DollarSign, Clock, 
            CheckCircle, AlertTriangle, XCircle, Download, RefreshCw, 
            Settings, LogOut, AlertCircle, TrendingUp, Calendar
        } = lucide;

        const IntegratedMedSpaSyncDashboard = () => {
            const [user, setUser] = useState(null);
            const [uploads, setUploads] = useState([]);
            const [reconciliationResults, setReconciliationResults] = useState(null);
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dragActive, setDragActive] = useState(false);
            const [error, setError] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [selectedUploadIds, setSelectedUploadIds] = useState([]);
            const [reconciliationSettings, setReconciliationSettings] = useState({
                matchCriteria: 'normal',
                dateToleranceDays: 7,
                amountTolerancePercent: 5
            });
            const [api] = useState(() => new window.MedSpaSyncAPI());
            const fileInputRef = useRef(null);

            // Check authentication and load initial data
            useEffect(() => {
                const initializeApp = async () => {
                    try {
                        // Check if user is authenticated
                        if (!api.isAuthenticated()) {
                            console.log('Not authenticated, redirecting to login');
                            window.location.href = 'login.html';
                            return;
                        }

                        // Test backend connection
                        setLoading(true);
                        console.log('Testing backend connection...');
                        await api.healthCheck();
                        console.log('Backend connection successful');

                        // Set user data (from JWT token - in real app you'd decode this)
                        setUser({
                            firstName: "Test",
                            lastName: "User", 
                            email: "test@medspasync.com",
                            practice: {
                                name: "TestSpa",
                                size: "small",
                                subscriptionTier: "trial"
                            }
                        });

                        // Load real data
                        await Promise.all([
                            loadUploadHistory(),
                            loadStats()
                        ]);

                    } catch (error) {
                        console.error('Failed to initialize app:', error);
                        setError(api.handleError(error, 'Initialization'));
                        
                        if (error.message.includes('Authentication required')) {
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                        }
                    } finally {
                        setLoading(false);
                    }
                };

                initializeApp();
            }, [api]);

            const loadUploadHistory = async () => {
                try {
                    console.log('Loading upload history...');
                    const response = await api.getUploadHistory();
                    if (response.success) {
                        console.log('Upload history loaded:', response.uploads);
                        setUploads(response.uploads || []);
                        
                        // Auto-select recent uploads for reconciliation
                        const recentUploads = response.uploads.slice(0, 3);
                        setSelectedUploadIds(recentUploads.map(u => u.id));
                    }
                } catch (error) {
                    console.error('Failed to load upload history:', error);
                    setError(api.handleError(error, 'Loading upload history'));
                }
            };

            const loadStats = async () => {
                try {
                    console.log('Loading statistics...');
                    const response = await api.getStats();
                    if (response.success) {
                        console.log('Statistics loaded:', response.stats);
                        setStats(response.stats);
                    }
                } catch (error) {
                    console.error('Failed to load stats:', error);
                    // Don't show error for stats - it's not critical
                }
            };

            const handleFileUpload = async (files) => {
                setLoading(true);
                setError(null);
                setUploadProgress(0);

                try {
                    const file = files[0];
                    console.log('Uploading file:', file.name, 'Size:', file.size);

                    const response = await api.uploadFile(file, (progress) => {
                        setUploadProgress(progress);
                        console.log('Upload progress:', progress + '%');
                    });

                    if (response.success) {
                        console.log('Upload successful:', response);
                        showNotification(`Successfully uploaded ${file.name}`, 'success');
                        
                        // Reload upload history and stats
                        await Promise.all([
                            loadUploadHistory(),
                            loadStats()
                        ]);
                        
                        // Reset progress
                        setUploadProgress(0);
                    } else {
                        throw new Error(response.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                    setError(api.handleError(error, 'File upload'));
                    setUploadProgress(0);
                } finally {
                    setLoading(false);
                }
            };

            const runReconciliation = async () => {
                if (selectedUploadIds.length < 2) {
                    setError('Please select at least 2 files for reconciliation');
                    return;
                }

                setLoading(true);
                setError(null);
                setReconciliationResults(null);

                try {
                    console.log('Running reconciliation with uploads:', selectedUploadIds);
                    console.log('Settings:', reconciliationSettings);

                    const response = await api.runReconciliation(selectedUploadIds, reconciliationSettings);

                    if (response.success) {
                        console.log('Reconciliation successful:', response);
                        setReconciliationResults(response);
                        showNotification(`Reconciliation complete: ${response.summary.totalMatches} matches found with ${response.summary.matchRate}% success rate`, 'success');
                        
                        // Switch to reconciliation tab to show results
                        setActiveTab('reconciliation');
                    } else {
                        throw new Error(response.error || 'Reconciliation failed');
                    }
                } catch (error) {
                    console.error('Reconciliation failed:', error);
                    setError(api.handleError(error, 'Reconciliation'));
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                console.log('Logging out...');
                api.logout();
                showNotification('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            };

            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 transform transition-all duration-300 ${
                    type === 'success' ? 'bg-green-500' : 'bg-red-500'
                }`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Remove after delay
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            if (document.body.contains(notification)) {
                                document.body.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 3000);
            };

            const formatCurrency = (amount) => {
                return api.formatCurrency(amount);
            };

            const formatDate = (dateString) => {
                return api.formatDate(dateString);
            };

            const getFileTypeColor = (fileType) => {
                const colors = {
                    pos_transactions: 'bg-blue-100 text-blue-800',
                    alle_rewards: 'bg-green-100 text-green-800',
                    aspire_certificates: 'bg-purple-100 text-purple-800',
                    unknown: 'bg-gray-100 text-gray-800'
                };
                return colors[fileType] || 'bg-gray-100 text-gray-800';
            };

            const getFileTypeLabel = (fileType) => {
                const labels = {
                    pos_transactions: 'POS Transactions',
                    alle_rewards: 'Alle Rewards',
                    aspire_certificates: 'Aspire Certificates',
                    unknown: 'Unknown Type'
                };
                return labels[fileType] || fileType;
            };

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileUpload(e.dataTransfer.files);
                }
            };

            const toggleUploadSelection = (uploadId) => {
                setSelectedUploadIds(prev => {
                    if (prev.includes(uploadId)) {
                        return prev.filter(id => id !== uploadId);
                    } else {
                        return [...prev, uploadId];
                    }
                });
            };

            const handleFileInputChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFileUpload(e.target.files);
                }
            };

            if (loading && !user) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="text-center">
                            <RefreshCw className="w-16 h-16 mx-auto text-blue-600 animate-spin" />
                            <p className="mt-6 text-xl text-gray-600">Connecting to MedSpaSync Pro...</p>
                            <p className="mt-2 text-sm text-gray-500">Loading your reconciliation dashboard</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-4">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                            <BarChart3 className="w-5 h-5 text-white" />
                                        </div>
                                        <span className="text-xl font-bold text-gray-900">MedSpaSync Pro</span>
                                    </div>
                                    <div className="hidden md:flex items-center space-x-4">
                                        <span className="text-sm text-gray-500">|</span>
                                        <span className="text-sm text-green-600 font-medium">✓ Connected</span>
                                    </div>
                                </div>
                                
                                <div className="flex items-center space-x-4">
                                    {user && (
                                        <div className="text-right">
                                            <div className="text-sm font-medium text-gray-900">{user.firstName} {user.lastName}</div>
                                            <div className="text-xs text-gray-500">{user.practice.name}</div>
                                        </div>
                                    )}
                                    <button className="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                                        <Settings className="w-5 h-5" />
                                    </button>
                                    <button onClick={handleLogout} className="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                                        <LogOut className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Error Alert */}
                        {error && (
                            <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                                <div className="flex">
                                    <AlertCircle className="h-5 w-5 text-red-400" />
                                    <div className="ml-3">
                                        <h3 className="text-sm font-medium text-red-800">Error</h3>
                                        <p className="mt-1 text-sm text-red-700">{error}</p>
                                        <button
                                            onClick={() => setError(null)}
                                            className="mt-2 text-sm text-red-600 hover:text-red-500 underline"
                                        >
                                            Dismiss
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Navigation Tabs */}
                        <div className="border-b border-gray-200 mb-8">
                            <nav className="-mb-px flex space-x-8">
                                {[
                                    { id: 'dashboard', name: 'Dashboard', icon: BarChart3 },
                                    { id: 'uploads', name: 'File Uploads', icon: Upload },
                                    { id: 'reconciliation', name: 'Reconciliation', icon: FileText },
                                    { id: 'reports', name: 'Reports', icon: Download }
                                ].map((tab) => {
                                    const Icon = tab.icon;
                                    return (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center space-x-2 py-4 px-1 border-b-2 font-medium text-sm transition-colors ${
                                                activeTab === tab.id
                                                    ? 'border-blue-500 text-blue-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            <Icon className="w-5 h-5" />
                                            <span>{tab.name}</span>
                                        </button>
                                    );
                                })}
                            </nav>
                        </div>

                        {/* Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8">
                                {/* Key Metrics */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center">
                                            <div className="flex-shrink-0">
                                                <FileText className="h-8 w-8 text-blue-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Total Records</p>
                                                <p className="text-2xl font-semibold text-gray-900">{stats?.totalRecords || 0}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center">
                                            <div className="flex-shrink-0">
                                                <Upload className="h-8 w-8 text-green-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Total Uploads</p>
                                                <p className="text-2xl font-semibold text-gray-900">{stats?.totalUploads || 0}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center">
                                            <div className="flex-shrink-0">
                                                <BarChart3 className="h-8 w-8 text-yellow-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Ready to Reconcile</p>
                                                <p className="text-2xl font-semibold text-gray-900">{selectedUploadIds.length}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center">
                                            <div className="flex-shrink-0">
                                                <Clock className="h-8 w-8 text-purple-600" />
                                            </div>
                                            <div className="ml-4">
                                                <p className="text-sm font-medium text-gray-500">Potential Pairs</p>
                                                <p className="text-2xl font-semibold text-gray-900">{stats?.reconciliationOpportunities?.potentialPairs || 0}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Quick Actions */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <button
                                            onClick={() => setActiveTab('uploads')}
                                            className="flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                        >
                                            <Upload className="w-5 h-5 mr-2 text-blue-600" />
                                            Upload New Files
                                        </button>
                                        <button
                                            onClick={runReconciliation}
                                            disabled={selectedUploadIds.length < 2 || loading}
                                            className="flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            {loading ? (
                                                <RefreshCw className="w-5 h-5 mr-2 animate-spin" />
                                            ) : (
                                                <BarChart3 className="w-5 h-5 mr-2" />
                                            )}
                                            Run Reconciliation
                                        </button>
                                    </div>
                                </div>

                                {/* Recent Uploads */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <h3 className="text-lg font-medium text-gray-900">Recent Uploads</h3>
                                    </div>
                                    <div className="p-6">
                                        {uploads.length === 0 ? (
                                            <div className="text-center py-8">
                                                <Upload className="w-12 h-12 mx-auto text-gray-400" />
                                                <p className="mt-2 text-sm text-gray-500">No files uploaded yet</p>
                                                <button
                                                    onClick={() => setActiveTab('uploads')}
                                                    className="mt-2 text-blue-600 hover:text-blue-500 text-sm"
                                                >
                                                    Upload your first file
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {uploads.slice(0, 5).map((upload) => (
                                                    <div key={upload.id} className="flex items-center justify-between p-3 border rounded-lg">
                                                        <div className="flex items-center space-x-3">
                                                            <FileText className="w-5 h-5 text-gray-400" />
                                                            <div>
                                                                <p className="text-sm font-medium text-gray-900">{upload.fileName}</p>
                                                                <p className="text-xs text-gray-500">{upload.recordCount} records</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${getFileTypeColor(upload.fileType)}`}>
                                                                {getFileTypeLabel(upload.fileType)}
                                                            </span>
                                                            <span className="text-xs text-gray-500">{formatDate(upload.createdAt)}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* File Uploads Tab */}
                        {activeTab === 'uploads' && (
                            <div className="space-y-8">
                                {/* Upload Zone */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="text-lg font-medium text-gray-900 mb-4">Upload Files</h3>
                                    
                                    {/* Upload Progress */}
                                    {uploadProgress > 0 && uploadProgress < 100 && (
                                        <div className="mb-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm text-gray-600">Uploading...</span>
                                                <span className="text-sm text-gray-600">{uploadProgress}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                <div
                                                    className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                                    style={{ width: `${uploadProgress}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    )}

                                    <div
                                        className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${
                                            dragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300'
                                        }`}
                                        onDragEnter={handleDrag}
                                        onDragLeave={handleDrag}
                                        onDragOver={handleDrag}
                                        onDrop={handleDrop}
                                    >
                                        <Upload className="mx-auto h-12 w-12 text-gray-400" />
                                        <h4 className="mt-4 text-lg font-medium text-gray-900">Drop files here or click to upload</h4>
                                        <p className="mt-2 text-sm text-gray-500">
                                            Supports CSV and Excel files (POS transactions, Alle rewards, Aspire certificates)
                                        </p>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept=".csv,.xlsx,.xls"
                                            onChange={handleFileInputChange}
                                            disabled={loading}
                                            className="hidden"
                                        />
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            disabled={loading}
                                            className="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-600 bg-blue-100 hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Choose File
                                        </button>
                                    </div>
                                </div>

                                {/* Upload History with Selection */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-medium text-gray-900">Upload History</h3>
                                            <div className="text-sm text-gray-500">
                                                {selectedUploadIds.length} selected for reconciliation
                                            </div>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Select
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        File Name
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Type
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Records
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Status
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Uploaded
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {uploads.map((upload) => (
                                                    <tr key={upload.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectedUploadIds.includes(upload.id)}
                                                                onChange={() => toggleUploadSelection(upload.id)}
                                                                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                                            />
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                            {upload.fileName}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${getFileTypeColor(upload.fileType)}`}>
                                                                {getFileTypeLabel(upload.fileType)}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                            {upload.recordCount}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                                <CheckCircle className="w-3 h-3 mr-1" />
                                                                {upload.status}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {formatDate(upload.createdAt)}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Reconciliation Tab */}
                        {activeTab === 'reconciliation' && (
                            <div className="space-y-8">
                                {/* Reconciliation Controls */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h3 className="text-lg font-medium text-gray-900">Reconciliation Analysis</h3>
                                        <button
                                            onClick={runReconciliation}
                                            disabled={loading || selectedUploadIds.length < 2}
                                            className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {loading ? (
                                                <RefreshCw className="w-4 h-4 mr-2 animate-spin" />
                                            ) : (
                                                <BarChart3 className="w-4 h-4 mr-2" />
                                            )}
                                            {loading ? 'Analyzing...' : 'Start Reconciliation'}
                                        </button>
                                    </div>

                                    {/* Reconciliation Settings */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Match Criteria
                                            </label>
                                            <select
                                                value={reconciliationSettings.matchCriteria}
                                                onChange={(e) => setReconciliationSettings({...reconciliationSettings, matchCriteria: e.target.value})}
                                                className="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            >
                                                <option value="strict">Strict (90%+ confidence)</option>
                                                <option value="normal">Normal (70%+ confidence)</option>
                                                <option value="fuzzy">Fuzzy (50%+ confidence)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Date Tolerance (days)
                                            </label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="30"
                                                value={reconciliationSettings.dateToleranceDays}
                                                onChange={(e) => setReconciliationSettings({...reconciliationSettings, dateToleranceDays: parseInt(e.target.value)})}
                                                className="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Amount Tolerance (%)
                                            </label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="50"
                                                value={reconciliationSettings.amountTolerancePercent}
                                                onChange={(e) => setReconciliationSettings({...reconciliationSettings, amountTolerancePercent: parseInt(e.target.value)})}
                                                className="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            />
                                        </div>
                                    </div>

                                    <div className="text-sm text-gray-600 mb-4">
                                        Selected {selectedUploadIds.length} files for reconciliation. 
                                        {selectedUploadIds.length < 2 && (
                                            <span className="text-yellow-600 ml-1">
                                                (Select at least 2 files from the Uploads tab)
                                            </span>
                                        )}
                                    </div>

                                    {loading && (
                                        <div className="text-center py-8">
                                            <RefreshCw className="w-8 h-8 mx-auto text-blue-600 animate-spin" />
                                            <p className="mt-2 text-sm text-gray-500">
                                                Running advanced reconciliation algorithms...
                                            </p>
                                        </div>
                                    )}
                                </div>

                                {/* Reconciliation Results */}
                                {reconciliationResults && (
                                    <div className="space-y-6">
                                        {/* Summary Cards */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div className="bg-white rounded-lg shadow p-6">
                                                <div className="flex items-center">
                                                    <CheckCircle className="h-8 w-8 text-green-600" />
                                                    <div className="ml-4">
                                                        <p className="text-sm font-medium text-gray-500">Total Matches</p>
                                                        <p className="text-2xl font-semibold text-gray-900">
                                                            {reconciliationResults.summary.totalMatches}
                                                        </p>
                                                        <p className="text-xs text-gray-500">
                                                            {reconciliationResults.summary.exactMatches} exact, {reconciliationResults.summary.fuzzyMatches} fuzzy
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-white rounded-lg shadow p-6">
                                                <div className="flex items-center">
                                                    <TrendingUp className="h-8 w-8 text-blue-600" />
                                                    <div className="ml-4">
                                                        <p className="text-sm font-medium text-gray-500">Match Rate</p>
                                                        <p className="text-2xl font-semibold text-gray-900">
                                                            {reconciliationResults.summary.matchRate}%
                                                        </p>
                                                        <p className="text-xs text-gray-500">
                                                            {reconciliationResults.summary.totalRecords} total records
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-white rounded-lg shadow p-6">
                                                <div className="flex items-center">
                                                    <Clock className="h-8 w-8 text-purple-600" />
                                                    <div className="ml-4">
                                                        <p className="text-sm font-medium text-gray-500">Time Saved</p>
                                                        <p className="text-2xl font-semibold text-gray-900">
                                                            {reconciliationResults.summary.timeSaved?.timeSavedHours || 0}h
                                                        </p>
                                                        <p className="text-xs text-gray-500">vs manual reconciliation</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Matches */}
                                        {reconciliationResults.matches && reconciliationResults.matches.length > 0 && (
                                            <div className="bg-white rounded-lg shadow">
                                                <div className="px-6 py-4 border-b border-gray-200">
                                                    <h3 className="text-lg font-medium text-gray-900">Matched Records</h3>
                                                </div>
                                                <div className="p-6">
                                                    <div className="space-y-4">
                                                        {reconciliationResults.matches.map((match) => (
                                                            <div key={match.id} className="border rounded-lg p-4 hover:bg-gray-50">
                                                                <div className="flex items-center justify-between mb-3">
                                                                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                                                        match.matchType === 'exact' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                                                    }`}>
                                                                        {match.matchType} match ({Math.round(match.confidence * 100)}% confidence)
                                                                    </span>
                                                                </div>
                                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                    <div>
                                                                        <p className="text-sm font-medium text-gray-900">{match.record1.fileName}</p>
                                                                        <p className="text-sm text-gray-600">
                                                                            {match.record1.data.patientName} - {formatCurrency(parseFloat(match.record1.data.amount || 0))} - {match.record1.data.service}
                                                                        </p>
                                                                    </div>
                                                                    <div>
                                                                        <p className="text-sm font-medium text-gray-900">{match.record2.fileName}</p>
                                                                        <p className="text-sm text-gray-600">
                                                                            {match.record2.data.patientName} - {match.record2.data.points} points - {match.record2.data.rewardType}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Unmatched Records */}
                                        {reconciliationResults.unmatched && reconciliationResults.unmatched.length > 0 && (
                                            <div className="bg-white rounded-lg shadow">
                                                <div className="px-6 py-4 border-b border-gray-200">
                                                    <h3 className="text-lg font-medium text-gray-900">Unmatched Records</h3>
                                                </div>
                                                <div className="p-6">
                                                    <div className="space-y-3">
                                                        {reconciliationResults.unmatched.map((item, index) => (
                                                            <div key={index} className="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                                                <div>
                                                                    <p className="text-sm font-medium text-gray-900">
                                                                        {item.record?.patientName || 'Unknown'} - {formatCurrency(parseFloat(item.record?.amount || 0))}
                                                                    </p>
                                                                    <p className="text-xs text-gray-500">{item.fileName}</p>
                                                                </div>
                                                                <span className="text-xs text-yellow-600">{item.reason}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Reports Tab */}
                        {activeTab === 'reports' && (
                            <div className="space-y-8">
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="text-lg font-medium text-gray-900 mb-6">Export Reports</h3>
                                    
                                    {reconciliationResults ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="border rounded-lg p-4">
                                                <h4 className="font-medium text-gray-900 mb-2">Executive Summary</h4>
                                                <p className="text-sm text-gray-600 mb-4">
                                                    High-level overview with {reconciliationResults.summary.totalMatches} matches 
                                                    and {reconciliationResults.summary.matchRate}% success rate
                                                </p>
                                                <button className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                                    <Download className="w-4 h-4 mr-2" />
                                                    Download PDF
                                                </button>
                                            </div>
                                            
                                            <div className="border rounded-lg p-4">
                                                <h4 className="font-medium text-gray-900 mb-2">Detailed Analysis</h4>
                                                <p className="text-sm text-gray-600 mb-4">
                                                    Complete match results, discrepancies, and recommendations
                                                </p>
                                                <button className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                                    <Download className="w-4 h-4 mr-2" />
                                                    Download Excel
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-8">
                                            <FileText className="w-12 h-12 mx-auto text-gray-400" />
                                            <p className="mt-2 text-sm text-gray-500">Run a reconciliation to generate reports</p>
                                            <button
                                                onClick={() => setActiveTab('reconciliation')}
                                                className="mt-2 text-blue-600 hover:text-blue-500 text-sm"
                                            >
                                                Go to Reconciliation
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the dashboard
        ReactDOM.render(<IntegratedMedSpaSyncDashboard />, document.getElementById('dashboard-root'));
    </script>
</body>
</html>
