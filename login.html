// enhanced-login.js
// âœ… Enhanced Login Script with full UX improvements

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('login-form');
  const statusDiv = document.getElementById('login-status');
  const togglePassword = document.getElementById('toggle-password');
  const rememberMe = document.getElementById('remember-me');
  const API_BASE_URL = 'https://ubiquitous-space-disco-69pvpp6r6jvw3rjpx-5000.app.github.dev/api';

  let failedAttempts = 0;
  let lockoutTimeout;

  // ðŸ” Auto-redirect if already logged in
  const storedToken = localStorage.getItem('token');
  if (storedToken) {
    statusDiv.textContent = 'ðŸ” Redirecting...';
    setTimeout(() => (window.location.href = 'index.html'), 800);
    return;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (lockoutTimeout) return;

    toggleFormDisabled(true);
    showStatus('ðŸ” Verifying credentials...', 'neutral');

    const email = form.email.value.trim();
    const password = form.password.value;

    try {
      const response = await fetch(`${API_BASE_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const result = await response.json();

      if (!response.ok) {
        failedAttempts++;
        showStatus(`âŒ ${result.message || 'Login failed.'}`, 'error');

        if (failedAttempts >= 3) {
          lockoutTimeout = setTimeout(() => {
            failedAttempts = 0;
            lockoutTimeout = null;
            showStatus('ðŸ” You can try again now.', 'neutral');
            toggleFormDisabled(false);
          }, 5000);
          showStatus('âš ï¸ Too many attempts. Please wait 5 seconds...', 'error');
        } else {
          toggleFormDisabled(false);
        }
        return;
      }

      // ðŸ§  Store token + user
      if (rememberMe.checked) {
        localStorage.setItem('token', result.token);
        localStorage.setItem('user', JSON.stringify(result.user));
      }

      showStatus('âœ… Login successful! Redirecting...', 'success');
      setTimeout(() => (window.location.href = 'index.html'), 1000);
    } catch (error) {
      console.error('Login error:', error);
      showStatus('ðŸš¨ Server error. Try again later.', 'error');
      toggleFormDisabled(false);
    }
  });

  togglePassword?.addEventListener('click', () => {
    const pwField = form.password;
    const isVisible = pwField.type === 'text';
    pwField.type = isVisible ? 'password' : 'text';
    togglePassword.textContent = isVisible ? 'ðŸ‘ï¸ Show' : 'ðŸ™ˆ Hide';
  });

  function toggleFormDisabled(disabled) {
    [...form.elements].forEach(el => (el.disabled = disabled));
  }

  function showStatus(message, type = 'neutral') {
    statusDiv.textContent = message;
    statusDiv.style.opacity = 0;
    statusDiv.style.color = type === 'error' ? '#ff4444' : type === 'success' ? '#4CAF50' : '#000';
    setTimeout(() => {
      statusDiv.style.opacity = 1;
      statusDiv.style.transition = 'opacity 0.4s ease-in-out';
    }, 50);
  }
});
